<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>
      
        
          Promiz Micro - Promises in 228 bytes (min+gzip) - Zolmeister - by Zoli Kahan
        
      
    </title>
    <meta name="description" content="Zolmeister - Blog - by Zoli Kahan" />
    <link href='https://zolmeister.com/favicon.ico' rel='icon' type='image/x-icon'/>

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />
    <!-- This is for syntax highlight -->
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />

    <!-- RSS -->
    <link rel="alternate" type="application/atom+xml" title="Zolmeister - Atom" href="https://www.zolmeister.com/feeds/posts/default" />
    <link rel="alternate" type="application/rss+xml" title="Zolmeister - RSS" href="https://www.zolmeister.com/feeds/posts/default?alt=rss" />

</head>
<body class="home-template">


    <main class="content" role="main">

    <article class="post">
        <header class="post-header">
            <a id="blog-logo" href="/">
                
                    <span class="blog-title">Zolmeister</span>
                
            </a>
        </header>

        <span class="post-meta">
        	<time datetime="2014-01-13">13 Jan 2014</time>
        	<!--
        		on
	        	
	        -->
       	</span>

        <h1 class="post-title"><a href="">Promiz Micro - Promises in 228 bytes (min+gzip)</a></h1>

        <section class="post-content">
            <p><a href="https://github.com/Zolmeister/promiz"><img src="https://raw.github.com/Zolmeister/promiz/master/imgs/logo.png" alt=""></a></p>

<p><strong>Update:</strong> <a href="https://github.com/Zolmeister/promiz">Promiz</a> is now an ES6 Promise polyfill. Check out the repo for more.</p>

<p><a href="https://github.com/Zolmeister/promiz">Promiz.js</a> (<a href="http://www.zolmeister.com/2013/07/promizjs.html">original post</a>) is a (now) completely <a href="http://promises-aplus.github.io/promises-spec/">Promises/A+</a> spec compliant library that fits in 590 bytes (min+gzip). In addition, the new&nbsp;<a href="https://github.com/Zolmeister/promiz#promiz-micro">Promiz Micro</a> comes in at 228 bytes (min+gzip) and provides an amazingly clean API.</p>

<h4>Promiz Micro:</h4>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="o">!</span><span class="kd">function</span><span class="p">(){</span><span class="kd">function</span> <span class="nx">a</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">){</span><span class="kd">function</span> <span class="nx">d</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">,</span><span class="nx">d</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">h</span><span class="o">&amp;&amp;</span><span class="s2">&quot;function&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">a</span><span class="p">)</span><span class="k">try</span><span class="p">{</span><span class="kd">var</span> <span class="nx">e</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">a</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span><span class="nx">e</span><span class="o">++||</span><span class="p">(</span><span class="nx">h</span><span class="o">=</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">())},</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span><span class="nx">e</span><span class="o">++||</span><span class="p">(</span><span class="nx">h</span><span class="o">=</span><span class="nx">a</span><span class="p">,</span><span class="nx">c</span><span class="p">())})}</span><span class="k">catch</span><span class="p">(</span><span class="nx">f</span><span class="p">){</span><span class="nx">h</span><span class="o">=</span><span class="nx">f</span><span class="p">,</span><span class="nx">c</span><span class="p">()}</span><span class="k">else</span> <span class="nx">d</span><span class="p">()}</span><span class="kd">function</span> <span class="nx">e</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">a</span><span class="p">;</span><span class="k">try</span><span class="p">{</span><span class="nx">a</span><span class="o">=</span><span class="nx">h</span><span class="o">&amp;&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nx">then</span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">i</span><span class="p">){</span><span class="k">return</span> <span class="nx">h</span><span class="o">=</span><span class="nx">i</span><span class="p">,</span><span class="nx">g</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="nx">e</span><span class="p">()}</span><span class="nx">d</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">g</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nx">e</span><span class="p">()},</span><span class="kd">function</span><span class="p">(){</span><span class="nx">g</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="nx">e</span><span class="p">()},</span><span class="kd">function</span><span class="p">(){</span><span class="k">try</span><span class="p">{</span><span class="mi">1</span><span class="o">==</span><span class="nx">g</span><span class="o">&amp;&amp;</span><span class="s2">&quot;function&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">b</span><span class="o">?</span><span class="nx">h</span><span class="o">=</span><span class="nx">b</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span><span class="o">:</span><span class="mi">2</span><span class="o">==</span><span class="nx">g</span><span class="o">&amp;&amp;</span><span class="s2">&quot;function&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">c</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nx">h</span><span class="o">=</span><span class="nx">c</span><span class="p">(</span><span class="nx">h</span><span class="p">),</span><span class="nx">g</span><span class="o">=</span><span class="mi">1</span><span class="p">)}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span> <span class="nx">h</span><span class="o">=</span><span class="nx">e</span><span class="p">,</span><span class="nx">j</span><span class="p">()}</span><span class="nx">h</span><span class="o">==</span><span class="nx">f</span><span class="o">?</span><span class="p">(</span><span class="nx">h</span><span class="o">=</span><span class="nx">TypeError</span><span class="p">(),</span><span class="nx">j</span><span class="p">())</span><span class="o">:</span><span class="nx">d</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">j</span><span class="p">(</span><span class="mi">3</span><span class="p">)},</span><span class="nx">j</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">j</span><span class="p">(</span><span class="mi">1</span><span class="o">==</span><span class="nx">g</span><span class="o">&amp;&amp;</span><span class="mi">3</span><span class="p">)})})}</span><span class="kd">var</span> <span class="nx">f</span><span class="o">=</span><span class="k">this</span><span class="p">,</span><span class="nx">g</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">h</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">i</span><span class="o">=</span><span class="p">[];</span><span class="nx">f</span><span class="p">.</span><span class="nx">promise</span><span class="o">=</span><span class="nx">f</span><span class="p">,</span><span class="nx">f</span><span class="p">.</span><span class="nx">resolve</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span><span class="k">return</span> <span class="nx">g</span><span class="o">||</span><span class="p">(</span><span class="nx">h</span><span class="o">=</span><span class="nx">a</span><span class="p">,</span><span class="nx">g</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">e</span><span class="p">)),</span><span class="k">this</span><span class="p">},</span><span class="nx">f</span><span class="p">.</span><span class="nx">reject</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span><span class="k">return</span> <span class="nx">g</span><span class="o">||</span><span class="p">(</span><span class="nx">h</span><span class="o">=</span><span class="nx">a</span><span class="p">,</span><span class="nx">g</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">e</span><span class="p">)),</span><span class="k">this</span><span class="p">},</span><span class="nx">f</span><span class="p">.</span><span class="nx">then</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">){</span><span class="kd">var</span> <span class="nx">d</span><span class="o">=</span><span class="k">new</span> <span class="nx">a</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">);</span><span class="k">return</span> <span class="mi">3</span><span class="o">==</span><span class="nx">g</span><span class="o">?</span><span class="nx">d</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span><span class="o">:</span><span class="mi">4</span><span class="o">==</span><span class="nx">g</span><span class="o">?</span><span class="nx">d</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span><span class="o">:</span><span class="nx">i</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d</span><span class="p">),</span><span class="nx">d</span><span class="p">};</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span><span class="nx">g</span><span class="o">=</span><span class="nx">a</span><span class="o">||</span><span class="mi">4</span><span class="p">,</span><span class="nx">i</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">){</span><span class="mi">3</span><span class="o">==</span><span class="nx">g</span><span class="o">&amp;&amp;</span><span class="nx">a</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span><span class="o">||</span><span class="nx">a</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">h</span><span class="p">)})}}</span><span class="s2">&quot;undefined&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nx">module</span><span class="o">?</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">a</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">Promiz</span><span class="o">=</span><span class="nx">a</span><span class="p">}();</span>
</code></pre></div>
<p>Recently I came across <a href="https://github.com/RubenVerborgh/promiscuous">Promiscuous</a>, a tiny spec compliant library&nbsp;which was written about in this <a href="http://ruben.verborgh.org/blog/2013/12/31/promiscuous-promises/">blog post</a>. I commented that Promiz was nearly as small and provided more features, however as <a href="https://github.com/RubenVerborgh">Ruben</a>&nbsp;pointed out, Promiz was not completely spec compliant. In fact, it had some major issues with regard to one particular use case where it failed completely. Here is an example of what would not have worked in the previous version of Promiz.js:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">Promiz</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
<span class="nx">promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fortyTwo</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">fortyTwo</span> <span class="o">===</span> <span class="mi">42</span><span class="p">)</span>
  <span class="k">return</span> <span class="mi">43</span>
<span class="p">})</span>

<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">fortyTwo</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// this fails, as it becomes 43</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="nx">fortyTwo</span> <span class="o">===</span> <span class="mi">42</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div>
<p>Thanks to Ruben for pointing out my mistake, I then decided to make Promiz fully compliant. However I had a big issue, which was that the entire model of Promiz was based on stack based execution which would have been a nightmare to alter to be able to support the above feature. So instead <strong>I re-wrote the whole thing</strong>.</p>

<h4>Basic Implementation</h4>

<p>In the process or re-writing the library, I started out by creating a minimal spec compliant library which would pass all of the <a href="https://github.com/promises-aplus/promises-tests">promise spec tests</a>. This is what became Promiz Micro, and I&#39;ll go over some of the concepts behind it&#39;s implementation.</p>

<h4>Promise State</h4>

<p>If you notice the above code (and read the spec), it specifies that once a promise has been resolved or rejected, it&#39;s state must not change. This meant that I decided to chain objects together, similar to a Tree/Linked List, by tracking pointers to each promise in the chain. Because of this, we need variables to track state:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>

<span class="c1">// .promise is required by the testing library, but not spec</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">promise</span> <span class="o">=</span> <span class="nx">self</span>

<span class="c1">// once set, state is immutable</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;pending&#39;</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">val</span> <span class="o">=</span> <span class="kc">null</span>

<span class="c1">// success and error functions</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">fn</span> <span class="o">=</span> <span class="nx">fn</span> <span class="o">||</span> <span class="kc">null</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">er</span> <span class="o">=</span> <span class="nx">er</span> <span class="o">||</span> <span class="kc">null</span>

<span class="c1">// array of pointers to chained promises</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="p">[];</span>
</code></pre></div>
<h4>Resolve and Then</h4>

<p>The implementation of the Resolve and Then functions is similar to the original implementation, except with Then it returns a new promise instead of itself:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">self</span><span class="p">.</span><span class="nx">resolve</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">state</span> <span class="o">===</span> <span class="s1">&#39;pending&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">val</span> <span class="o">=</span> <span class="nx">v</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;resolving&#39;</span>
    <span class="nx">setImmediate</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">fire</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span>
<span class="p">}</span>

<span class="nx">self</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">er</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
  <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">promise</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">er</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">state</span> <span class="o">===</span> <span class="s1">&#39;resolved&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">val</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">state</span> <span class="o">===</span> <span class="s1">&#39;rejected&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">val</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">next</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">p</span>
<span class="p">}</span>
</code></pre></div>
<h4>2.3.3.1 - <a href="http://promises-aplus.github.io/promises-spec/#point-66">Let then be x.then</a></h4>

<p>One of the more frustrating parts of the spec is the requirement that the x.then function on a thenable (promise) is only accessed once. This means that when we check to see if an object has &#39;.then&#39;, we have to save that value to a variable if we want to call it later. Not only that, when we try accessing that value, it may throw an exception (<a href="http://promises-aplus.github.io/promises-spec/#point-78">2.3.3.3.4</a>).</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">self</span><span class="p">.</span><span class="nx">fire</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
  <span class="c1">// check if it&#39;s a thenable</span>
  <span class="kd">var</span> <span class="nx">ref</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">ref</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">val</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">val</span><span class="p">.</span><span class="nx">then</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">val</span> <span class="o">=</span> <span class="nx">e</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;rejecting&#39;</span>
    <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fire</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="p">...</span>
</code></pre></div>
<h4>Resolve input promises, then apply functions, then resolve output promises</h4>

<p>Part of the way I implemented the .resolve function meant that an input value (the current self.val) could potentially be a promise (this is part of the spec), so we have to resolve that promise before we do anything else. I created a helper function for this step, because we will want to re-use this code again for the last step of resolving the output value. We also have to protect the functions passed in because they are &#39;abused&#39; in the testing code (not part of spec).</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// ref : reference to &#39;then&#39; function</span>
<span class="c1">// cb, ec, cn : successCallback, failureCallback, notThennableCallback</span>
<span class="nx">self</span><span class="p">.</span><span class="nx">thennable</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ref</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">ec</span><span class="p">,</span> <span class="nx">cn</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">val</span> <span class="o">=</span> <span class="nx">val</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">val</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">val</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">ref</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// cnt protects against abuse calls from spec checker</span>
      <span class="kd">var</span> <span class="nx">cnt</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="nx">ref</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cnt</span><span class="o">++</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span>
        <span class="nx">cb</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
      <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cnt</span><span class="o">++</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span>
        <span class="nx">ec</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ec</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">cn</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4>Apply functions</h4>

<p>This step is fairly straight forward. We need to apply the given functions to our current value, and watch out for errors.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">state</span> <span class="o">===</span> <span class="s1">&#39;resolving&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fn</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">val</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">val</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">val</span> <span class="o">=</span> <span class="nx">e</span>
    <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">finish</span><span class="p">(</span><span class="s1">&#39;rejected&#39;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">state</span> <span class="o">===</span> <span class="s1">&#39;rejecting&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">self</span><span class="p">.</span><span class="nx">er</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">val</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">er</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">val</span><span class="p">)</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;resolving&#39;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">val</span> <span class="o">=</span> <span class="nx">e</span>
    <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">finish</span><span class="p">(</span><span class="s1">&#39;rejected&#39;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4>2.3.1 - <a href="http://promises-aplus.github.io/promises-spec/#point-57">TypeError</a></h4>

<p>Part of the spec specifies that we should avoid direct circular loops, where we return our own promise as a return value from a function. If someone tries to do this, we need to throw a TypeError exception:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">val</span> <span class="o">===</span> <span class="nx">self</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">val</span> <span class="o">=</span> <span class="nx">TypeError</span><span class="p">()</span>
  <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">finish</span><span class="p">(</span><span class="s1">&#39;rejected&#39;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h4>Finish</h4>

<p>Finally, we finish up our call by finalizing our state and calling the next promise in the chain:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">self</span><span class="p">.</span><span class="nx">finish</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">type</span> <span class="o">||</span> <span class="s1">&#39;rejected&#39;</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">next</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="s1">&#39;resolved&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">val</span><span class="p">)</span> <span class="o">||</span> <span class="nx">p</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">val</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div>
<h4>Performance</h4>

<p>This re-write, being spec compliant, no longer resolves synchronously. This means it takes a huge performance hit, but not more that other Promises/A+ compliant libraries already have to deal with. That being said, if you&#39;re after a fast (but heavy) Promises/A+ implementation, I recommend checking out <a href="https://github.com/petkaantonov/bluebird">bluebird</a>.</p>

        </section>

        

        <footer class="post-footer">
        	<!-- If we want to display author's name and bio -->
            
                <section class="author">
                	<header> <a href=""> <img class="profile" src="/assets/images/profile.png" alt="Zolmeister"></a></header>
                	<article>
                		<!-- Author Name -->
                    	<h4> Zoli Kahan </h4>
                    	<!-- Author Bio -->
                    	<p>
                    		<a target="_blank" href="https://zolikahan.com">Projects</a> |
                        <a target="_blank" href="https://github.com/Zolmeister">GitHub</a>
                    	</p>
                    </article>
                </section>
            

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/share?text=Promiz Micro - Promises in 228 bytes (min+gzip)&amp;url=https://zolmeister.com/2014/01/promiz-micro-promises-in-228-bytes.html"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://zolmeister.com/2014/01/promiz-micro-promises-in-228-bytes.html"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://zolmeister.com/2014/01/promiz-micro-promises-in-228-bytes.html"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

            
            <section class="disqus">
        	    <div id="disqus_thread"></div>
              <script type="text/javascript">
                  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                  var disqus_shortname = 'zolmeister'; // required: replace example with your forum shortname

                  /* * * DON'T EDIT BELOW THIS LINE * * */
                  (function() {
                      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                  })();
              </script>

            </section>
            

        </footer>

    </article>

</main>


    <footer class="site-footer">
        <a class="subscribe icon-feed" href="feeds/posts/default"><span class="tooltip">Subscribe!</span></a>
        <div class="inner">
             <section class="copyright">All content copyright <a href="">Zolmeister</a> &copy;  &bull; All rights reserved.</section>
        </div>
    </footer>


    <script type="text/javascript" src="/assets/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-30570115-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</body>
</html>
